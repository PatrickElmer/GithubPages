<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Github Pages</title>
    <link rel="stylesheet" href="pico.classless.css">
    <link rel="stylesheet" href="bubble.css">
    <link rel="shortcut icon" href="#" type="image/x-icon">
</head>
<body>
    <main>
        <header>
            <nav>
                <input type="search" name="search" onkeyup="_render_filtered_filelist()">
            </nav>
        </header>
        <div id="filelist"></div>
    </main>
    <main style="display: none;">
        <header>
            <nav>
                <ul>
                    <li><a href="#">Zur√ºck</a></li>
                </ul>
                <ul>
                    <li><button onclick="_save()" id="saveButton">Speichern</button></li>
                </ul>
                <ul>
                    <li><a onclick="_logout()">Ausloggen</a></li>
                </ul>
            </nav>
        </header>
        <div id="editor" spellcheck="false"></div>
    </main>
    <script src="base64.min.js"></script>
    <script src="github.js"></script>
    <script src="showdown.js"></script>
    <script src="quill_2.0.3.js"></script>
    <script>
        const quill = new Quill('#editor', {
            theme: 'bubble',
            modules: {toolbar: [{'header': 1}, {'header': 2}, 'bold', 'italic']}
            // 'underline', 'strike', 'blockquote', 'code-block', 'link', 'image', 'video', 'formula', {'list': 'ordered'}, {'list': 'bullet'}, {'list': 'check'}, {'script': 'sub'}, {'script': 'super'}, {'indent': '-1'}, {'indent': '+1'}, {'direction': 'rtl'}, 'clean'
        })

        const gh_token = localStorage.getItem("gh_token") || prompt("gh_token")
        if (gh_token !== null) localStorage.setItem("gh_token", gh_token)
        const api = new GithubAPI(
            owner="PatrickElmer",
            repo="GithubAPI",
            token=localStorage.getItem("gh_token"),
        )

        window.addEventListener('DOMContentLoaded', onRouteChange)
        window.addEventListener('hashchange', onRouteChange)
        async function onRouteChange() {
            const hash = window.location.hash.substring(1).replace(/^\//, '')
            const ext = "md"
            if (hash === "") {
                document.querySelector("#editor").parentElement.style.display = "none"
                _init()
                document.querySelector("#filelist").parentElement.style.display = "block"
            } else {
                document.querySelector("#filelist").parentElement.style.display = "none"
                const content = await api.open(`${hash}.${ext}`)
                updateContent(content)
                document.querySelector("#editor").parentElement.style.display = "block"
            }
        }
        function updateContent(content) {
            var converter = new showdown.Converter()
            const element = document.querySelector(".ql-editor")
            element.innerHTML = converter.makeHtml(content)
            element.scrollTo(0, 0)
        }

        function _logout() {
            localStorage.removeItem("gh_token")
            location.reload()
        }
        async function _save() {
            const saveButton = document.getElementById("saveButton")
            saveButton.setAttribute('aria-busy', true)
            const ext = "md"
            const html = quill.getSemanticHTML()
            const converter = new showdown.Converter()
            const content = converter.makeMarkdown(html)
                .replaceAll("\n\n\n\n", "\n\n")
                .replace(/\n+$/, '\n')
            const hash = window.location.hash.substring(1).replace(/^\//, '')
            const path = `${hash}.${ext}`
            await api.save(path, content)
            saveButton.setAttribute('aria-busy', false)
        }

        const filelist = {files: null}
        async function _init() {
            const search = document.querySelector("input[name='search']")
            search.value = ""
            search.focus()
            const data = await api.request("")
            const files = data
                .filter(item => item.type === "file" && item.path.endsWith(".md"))
                .map(item => item.path.slice(0, -3))
            filelist.files = files
            _render_filelist(files)
        }
        function _render_filelist(files) {
            const element = document.querySelector("#filelist")
            element.innerHTML = ""
            element.style.textTransform = "capitalize"
            for (const file of files) {
                const p = document.createElement("p")
                const a = document.createElement("a")
                a.textContent = file.replace("-", " ")
                a.href = `#${file}`
                p.appendChild(a)
                element.appendChild(p)
            }
            element.scrollTo(0, 0)
        }
        function _render_filtered_filelist() {
            const search = document.querySelector("input[name='search']")
            _render_filelist(filelist.files.filter(filename => filename.includes(search.value.toLowerCase())))
        }
    </script>
</body>
</html>
